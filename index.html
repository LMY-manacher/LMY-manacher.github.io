<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CPU计算与磁传感器采集</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      padding: 20px; 
      max-width: 800px; 
      margin: 0 auto;
    }
    h1 { color: #333; text-align: center; }
    .container { 
      display: flex;
      flex-direction: column; 
      gap: 15px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background-color: #007aff;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .status {
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 4px;
      font-size: 16px;
    }
    .data-display {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .data-card {
      flex: 1;
      min-width: 150px;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 4px;
      text-align: center;
    }
    .value {
      font-size: 24px;
      font-weight: bold;
      display: block;
    }
    .label {
      font-size: 14px;
      color: #666;
    }
    .progress-bar {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 4px;
      margin-top: 10px;
      overflow: hidden;
    }
    .progress {
      width: 0%;
      height: 10px;
      background-color: #4CAF50;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <h1>CPU计算与磁传感器采集</h1>
  
  <div class="container">
    <div class="card">
      <div class="form-group">
        <label for="usrId">用户ID：</label>
        <input type="text" id="usrId" placeholder="请输入用户ID">
      </div>
      <div class="form-group">
        <label for="deviceId">设备编号：</label>
        <input type="text" id="deviceId" placeholder="请输入设备编号">
      </div>
      <div class="form-group">
        <label for="computeLevel">CPU计算强度 (1-10)：</label>
        <input type="number" id="computeLevel" min="1" max="10" value="5">
      </div>
      <div class="form-group">
        <label for="computeDuration">计算持续时间 (秒)：</label>
        <input type="number" id="computeDuration" min="5" max="300" value="30">
      </div>
    </div>

    <div class="card">
      <button id="startBtn">开始任务</button>
      <button id="stopBtn" disabled>停止任务</button>
      <div class="progress-bar">
        <div id="progress" class="progress"></div>
      </div>
    </div>

    <div class="card">
      <div class="status" id="cpuStatus">CPU状态：就绪</div>
      <div class="status" id="sensorStatus">传感器状态：等待启动</div>
    </div>

    <div class="card">
      <h3>磁传感器数据</h3>
      <div class="data-display">
        <div class="data-card">
          <span class="value" id="magX">-</span>
          <span class="label">X轴 (μT)</span>
        </div>
        <div class="data-card">
          <span class="value" id="magY">-</span>
          <span class="label">Y轴 (μT)</span>
        </div>
        <div class="data-card">
          <span class="value" id="magZ">-</span>
          <span class="label">Z轴 (μT)</span>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>CPU计算状态</h3>
      <div class="status" id="computeResult">尚未开始计算</div>
    </div>
  </div>

  <script>
    // DOM元素
    const usrIdInput = document.getElementById('usrId');
    const deviceIdInput = document.getElementById('deviceId');
    const computeLevelInput = document.getElementById('computeLevel');
    const computeDurationInput = document.getElementById('computeDuration');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const progressBar = document.getElementById('progress');
    const cpuStatus = document.getElementById('cpuStatus');
    const sensorStatus = document.getElementById('sensorStatus');
    const magXDisplay = document.getElementById('magX');
    const magYDisplay = document.getElementById('magY');
    const magZDisplay = document.getElementById('magZ');
    const computeResult = document.getElementById('computeResult');

    // 全局变量
    let isRunning = false;
    let sensorData = [];
    let computeWorker = null;
    let deviceOrientationHandler = null;
    let startTime = 0;
    let duration = 0;
    let progressInterval = null;

    // iOS设备请求传感器权限
    async function requestSensorPermission() {
      if (typeof DeviceOrientationEvent !== 'undefined' && 
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        try {
          const response = await DeviceOrientationEvent.requestPermission();
          if (response !== 'granted') {
            alert('需要授权访问设备传感器才能进行数据采集');
            return false;
          }
          return true;
        } catch (error) {
          console.error('传感器权限请求失败:', error);
          alert('传感器权限请求失败: ' + error.message);
          return false;
        }
      }
      return true; // 非iOS设备或旧版iOS不需要请求权限
    }

    // 创建Web Worker用于CPU密集计算
    function createComputeWorker() {
      // 使用Blob方式创建Worker，避免跨域问题
      const workerCode = `
        self.onmessage = function(e) {
          const { level, duration } = e.data;
          const startTime = Date.now();
          const endTime = startTime + (duration * 1000);
          
          // 根据计算强度设置不同的计算任务
          const iterationsBase = 10000 * level;
          let result = 0;
          let rounds = 0;
          
          while (Date.now() < endTime) {
            // 计算大量的斐波那契数列
            for (let i = 0; i < iterationsBase; i++) {
              result = calculateFibonacci(Math.floor(30 + level/2));
            }
            rounds++;
            self.postMessage({ type: 'progress', rounds, result });
          }
          
          self.postMessage({ 
            type: 'complete', 
            rounds, 
            result,
            timeElapsed: (Date.now() - startTime) / 1000
          });
        };
        
        function calculateFibonacci(n) {
          if (n <= 1) return n;
          return calculateFibonacci(n-1) + calculateFibonacci(n-2);
        }
      `;
      
      const blob = new Blob([workerCode], { type: 'application/javascript' });
      return new Worker(URL.createObjectURL(blob));
    }

    // 开始采集传感器数据
    function startSensorCollection() {
      sensorData = [];
      sensorStatus.textContent = '传感器状态：正在采集数据...';
      
      deviceOrientationHandler = function(event) {
        // iOS Safari中磁力计数据通过DeviceOrientationEvent的webkitCompassHeading获取方向
        // 但完整的磁力计数据需要额外的API支持，这里我们使用orientation数据作为替代
        const timestamp = Date.now();
        const alpha = event.alpha;  // Z轴旋转角度 (指南针朝向)
        const beta = event.beta;    // X轴旋转角度
        const gamma = event.gamma;  // Y轴旋转角度
        
        // 如果有磁力计事件(Safari中一般不提供完整磁力计数据)
        const compass = event.webkitCompassHeading || null;
        const accuracy = event.webkitCompassAccuracy || null;
        
        // 保存数据
        sensorData.push({
          time: timestamp,
          alpha: alpha,
          beta: beta,
          gamma: gamma,
          compass: compass,
          accuracy: accuracy
        });
        
        // 更新显示
        magXDisplay.textContent = beta ? beta.toFixed(2) : '-';
        magYDisplay.textContent = gamma ? gamma.toFixed(2) : '-';
        magZDisplay.textContent = alpha ? alpha.toFixed(2) : '-';
      };
      
      window.addEventListener('deviceorientation', deviceOrientationHandler);
    }

    // 启动CPU计算任务
    function startCpuTask(level, durationSeconds) {
      cpuStatus.textContent = 'CPU状态：正在进行密集计算...';
      computeResult.textContent = '计算中...';
      
      // 创建并启动worker
      computeWorker = createComputeWorker();
      computeWorker.postMessage({ level, duration: durationSeconds });
      
      computeWorker.onmessage = function(e) {
        const data = e.data;
        
        if (data.type === 'progress') {
          computeResult.textContent = `已完成 ${data.rounds} 轮计算，当前值: ${data.result}`;
        } else if (data.type === 'complete') {
          computeResult.textContent = `计算完成! 总共执行了 ${data.rounds} 轮计算，耗时 ${data.timeElapsed.toFixed(2)} 秒`;
          cpuStatus.textContent = 'CPU状态：计算完成';
          stopTask();
        }
      };
    }

    // 更新进度条
    function updateProgressBar() {
      if (!isRunning) return;
      
      const now = Date.now();
      const elapsed = (now - startTime) / 1000;
      const percent = Math.min((elapsed / duration) * 100, 100);
      
      progressBar.style.width = `${percent}%`;
      
      if (percent >= 100) {
        clearInterval(progressInterval);
      }
    }

    // 停止任务并上传数据
    function stopTask() {
      if (!isRunning) return;
      
      isRunning = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      
      // 停止进度条更新
      clearInterval(progressInterval);
      progressBar.style.width = '100%';
      
      // 停止CPU计算
      if (computeWorker) {
        computeWorker.terminate();
        computeWorker = null;
        cpuStatus.textContent = 'CPU状态：已停止';
      }
      
      // 停止传感器数据采集
      if (deviceOrientationHandler) {
        window.removeEventListener('deviceorientation', deviceOrientationHandler);
        deviceOrientationHandler = null;
        sensorStatus.textContent = '传感器状态：采集已停止，准备上传...';
      }
      
      // 准备数据上传
      const usrId = usrIdInput.value.trim();
      const deviceId = deviceIdInput.value.trim();
      
      if (sensorData.length === 0) {
        sensorStatus.textContent = '传感器状态：没有采集到数据，无需上传';
        return;
      }
      
      // 转换为CSV格式
      let csvContent = "time,alpha,beta,gamma,compass,accuracy\n";
      sensorData.forEach(item => {
        csvContent += `${item.time},${item.alpha},${item.beta},${item.gamma},${item.compass},${item.accuracy}\n`;
      });
      
      // 编码数据并准备上传
      const encodedCSV = btoa(unescape(encodeURIComponent(csvContent)));
      const payload = {
        ReqInfo: {
          usrId: usrId,
          deviceId: deviceId,
          mag: {
            data: encodedCSV,
            sequence: JSON.stringify([1, 2, 3])
          },
          reqTime: new Date().toISOString()
        }
      };
      
      const payloadStr = JSON.stringify(payload);
      const encodedPayload = btoa(unescape(encodeURIComponent(payloadStr)));
      
      // 模拟上传过程 - 实际使用时替换为真实的服务器地址
      sensorStatus.textContent = '传感器状态：正在上传数据...';
      
      // 打印数据（调试用）- 实际使用时可以用fetch上传
      console.log('准备上传的数据:', payload);
      
      // 模拟上传成功
      setTimeout(() => {
        sensorStatus.textContent = '传感器状态：数据上传成功 (模拟)';
        
        // 可以将下面注释取消，改为实际上传数据
        /*
        fetch("http://your-server-url/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Data-Type": "device_mag_data"
          },
          body: encodedPayload
        })
        .then(response => response.text())
        .then(data => {
          try {
            const decodedResponse = atob(data);
            sensorStatus.textContent = "传感器状态：数据上传成功，服务器响应：" + decodedResponse;
          } catch (error) {
            sensorStatus.textContent = "传感器状态：数据上传成功，但返回非Base64格式响应";
          }
        })
        .catch(error => {
          console.error("上传失败：", error);
          sensorStatus.textContent = "传感器状态：数据上传失败：" + error;
        });
        */
      }, 1500);
      
      // 保存数据到本地供调试
      const dataStr = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", `mag_data_${usrId}_${deviceId}_${Date.now()}.csv`);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    }

    // 事件监听
    startBtn.addEventListener('click', async function() {
      const usrId = usrIdInput.value.trim();
      const deviceId = deviceIdInput.value.trim();
      const computeLevel = parseInt(computeLevelInput.value) || 5;
      const computeDuration = parseInt(computeDurationInput.value) || 30;
      
      if (!usrId || !deviceId) {
        alert('请填写用户ID和设备编号');
        return;
      }
      
      // 请求传感器权限
      const permissionGranted = await requestSensorPermission();
      if (!permissionGranted) return;
      
      // 开始任务
      isRunning = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      startTime = Date.now();
      duration = computeDuration;
      
      // 初始化进度条
      progressBar.style.width = '0%';
      progressInterval = setInterval(updateProgressBar, 100);
      
      // 开始传感器数据采集
      startSensorCollection();
      
      // 开始CPU计算
      startCpuTask(computeLevel, computeDuration);
      
      // 设置自动停止
      setTimeout(() => {
        if (isRunning) {
          stopTask();
        }
      }, computeDuration * 1000);
    });

    stopBtn.addEventListener('click', stopTask);
  </script>
</body>
</html> 
